#!/bin/bash

# Specify the host project ID
HOST_PROJECT_ID="your-host-project-id"

# Specify the region (replace with the appropriate region of your subnets)
REGION="your-region"

# Read subnet names from the text file
SUBNETS_FILE="subnets.txt"

# Output file
OUTPUT_FILE="output.txt"

# Clear the output file before writing
> "$OUTPUT_FILE"

# Function to get service projects for a given subnet
get_service_projects_for_subnet() {
    local subnet_name=$1

    # List all associated service projects for the Shared VPC
    gcloud compute shared-vpc associated-projects list $HOST_PROJECT_ID --format="value(projectId)" | while read project_id; do
        # Check if the subnet exists in the current service project
        if gcloud compute networks subnets list --project=$project_id --filter="name=$subnet_name AND region=($REGION)" --format="value(name)" | grep -q "^$subnet_name$"; then
            echo "  - Used by service project: $project_id" >> "$OUTPUT_FILE"
        fi
    done
}

# Loop through each subnet and find associated service projects
while IFS= read -r subnet; do
    echo "Subnet: $subnet" >> "$OUTPUT_FILE"
    get_service_projects_for_subnet "$subnet"
    echo "---------------------------------" >> "$OUTPUT_FILE"
done < "$SUBNETS_FILE"

echo "Results have been saved to $OUTPUT_FILE"
