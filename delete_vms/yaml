name: 'Delete GCP VM (2-Step)'

on:
  workflow_dispatch:
    inputs:
      gcp_project_id:
        description: 'The GCP Project ID where the VM to be DELETED resides'
        required: true
        type: string
      gcp_zone:
        description: 'The zone of the VM to be DELETED (e.g., us-central1-a)'
        required: true
        type: string
      instance_name:
        description: 'The name of the VM instance to PERMANENTLY DELETE'
        required: true
        type: string

jobs:
  # =================================================================
  # JOB 1: VALIDATE AND DRY RUN
  # =================================================================
  dry-run:
    name: 'Step 1: Validate & Dry Run Deletion Plan'
    runs-on: ubuntu-latest

    permissions:
      contents: 'read'
      id-token: 'write'

    steps:
      - name: 'Authenticate to Google Cloud'
        uses: 'google-github-actions/auth@v2'
        with:
          workload_identity_provider: '${{ secrets.GCP_WIF_PROVIDER }}'
          service_account: '${{ secrets.GCP_SERVICE_ACCOUNT }}'

      - name: 'Set up gcloud CLI'
        uses: 'google-github-actions/setup-gcloud@v2'
        with:
          project_id: '${{ inputs.gcp_project_id }}'

      - name: 'Display Deletion Plan'
        run: |
          echo "ðŸ›‘ DANGER: THIS IS A DESTRUCTIVE ACTION ðŸ›‘"
          echo " "
          echo "âœ… DRY RUN: The next job will PERMANENTLY DELETE the following VM:"
          echo "--------------------------------------------------"
          echo "Project ID:    ${{ inputs.gcp_project_id }}"
          echo "Zone:          ${{ inputs.gcp_zone }}"
          echo "Instance Name: ${{ inputs.instance_name }}"
          echo "--------------------------------------------------"
          echo " "
          echo "This action is irreversible. If this is incorrect, CANCEL THE WORKFLOW RUN IMMEDIATELY."

  # =================================================================
  # JOB 2: APPLY DELETION
  # =================================================================
  execute-deletion:
    name: 'Step 2: Execute VM Deletion'
    runs-on: ubuntu-latest
    needs: dry-run
    if: github.event_name == 'workflow_dispatch'

    permissions:
      contents: 'read'
      id-token: 'write'

    steps:
      - name: 'Authenticate to Google Cloud'
        uses: 'google-github-actions/auth@v2'
        with:
          workload_identity_provider: '${{ secrets.GCP_WIF_PROVIDER }}'
          service_account: '${{ secrets.GCP_SERVICE_ACCOUNT }}'

      - name: 'Set up gcloud CLI'
        uses: 'google-github-actions/setup-gcloud@v2'
        with:
          project_id: '${{ inputs.gcp_project_id }}'

      - name: 'Execute Deletion Command'
        run: |
          echo "ðŸ”´ PERMANENTLY DELETING VM: ${{ inputs.instance_name }} in zone ${{ inputs.gcp_zone }}"
          # This is the destructive command. The --quiet flag auto-confirms the deletion prompt.
          gcloud compute instances delete ${{ inputs.instance_name }} \
            --zone=${{ inputs.gcp_zone }} \
            --project=${{ inputs.gcp_project_id }} \
            --quiet
          echo "âœ… Successfully deleted VM."
